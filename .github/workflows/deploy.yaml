name: Build and Deploy

'on':
  push:
    branches:
      - main
    paths:
      - backend/**
      - helm/**
      - .github/workflows/deploy.yaml
  workflow_dispatch:

    null
env:
  ACR_NAME: ${{ vars.ACR_NAME }}
  AKS_CLUSTER: ${{ vars.AKS_CLUSTER }}
  AKS_RESOURCE_GROUP: ${{ vars.AKS_RESOURCE_GROUP }}
  KEY_VAULT_NAME: ${{ vars.KEY_VAULT_NAME }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  MANAGED_IDENTITY_CLIENT_ID: ${{ vars.MANAGED_IDENTITY_CLIENT_ID }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
    strategy:
      matrix:
        service:
          - auth
          - puppies
          - chat
          - expert
        include:
          - service: auth
            context: ./backend
            dockerfile: ./backend/packages/auth/Dockerfile
          - service: puppies
            context: ./backend
            dockerfile: ./backend/packages/puppies/Dockerfile
          - service: chat
            context: ./backend
            dockerfile: ./backend/packages/chat/Dockerfile
          - service: expert
            context: ./backend
            dockerfile: ./backend/packages/expert/Dockerfile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_NAME }}.azurecr.io/puppy-store-${{ matrix.service }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  deploy:
    if: false  # Temporarily disabled
    needs: build
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER }}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Deploy with Helm
        run: |
          helm upgrade --install puppy-store ./helm/puppy-store \
            --namespace puppy-store \
            --create-namespace \
            -f ./helm/puppy-store/values-prod.yaml \
            --set keyVault.name=${{ env.KEY_VAULT_NAME }} \
            --set keyVault.tenantId=${{ env.AZURE_TENANT_ID }} \
            --set keyVault.userAssignedIdentityID=${{ env.MANAGED_IDENTITY_CLIENT_ID }} \
            --set auth.image.repository=${{ env.ACR_NAME }}.azurecr.io/puppy-store-auth \
            --set auth.image.tag=${{ needs.build.outputs.image-tag }} \
            --set puppies.image.repository=${{ env.ACR_NAME }}.azurecr.io/puppy-store-puppies \
            --set puppies.image.tag=${{ needs.build.outputs.image-tag }} \
            --set chat.image.repository=${{ env.ACR_NAME }}.azurecr.io/puppy-store-chat \
            --set chat.image.tag=${{ needs.build.outputs.image-tag }} \
            --set expert.image.repository=${{ env.ACR_NAME }}.azurecr.io/puppy-store-expert \
            --set expert.image.tag=${{ needs.build.outputs.image-tag }} \
            --wait \
            --timeout 5m